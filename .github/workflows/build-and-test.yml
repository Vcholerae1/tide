name: Build and test

on: 
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build_wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-22.04, windows-2022, macos-14]
        python-version: ["3.12"]

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      # Linux: Install CUDA
      - name: Install CUDA (Linux)
        if: runner.os == 'Linux'
        run: |
          # Install CUDA toolkit
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2204/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get -y install cuda-toolkit-12-4
          echo "CUDA_PATH=/usr/local/cuda-12.4" >> $GITHUB_ENV
          echo "CUDA_HOME=/usr/local/cuda-12.4" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/local/cuda-12.4/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "/usr/local/cuda-12.4/bin" >> $GITHUB_PATH

      # Windows: Install CUDA
      - name: Install CUDA (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          # Bundle Intel OpenMP runtime for wheels
          nuget install intelopenmp.devel.win -DirectDownload -NonInteractive
          nuget install intelopenmp.redist.win -DirectDownload -NonInteractive
          Copy-Item intelopenmp.devel.win*/build/native/win-x64/libiomp5md.lib src/tide/ -Force
          Copy-Item intelopenmp.redist.win*/runtimes/win-x64/native/libiomp5md.dll src/tide/ -Force
          # Download and install CUDA
          Invoke-WebRequest -Uri "https://developer.download.nvidia.com/compute/cuda/12.4.0/network_installers/cuda_12.4.0_windows_network.exe" -OutFile "cuda_installer.exe"
          Start-Process -Wait -FilePath ".\cuda_installer.exe" -ArgumentList "-s", "nvcc_12.4", "cudart_12.4", "visual_studio_integration_12.4"
          $cudaPath = "C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4"
          "CUDA_PATH=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CUDA_HOME=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CUDA_PATH_V12_4=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CudaToolkitDir=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "CUDAToolkit_ROOT=$cudaPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          "$cudaPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      # macOS: No CUDA, CPU only
      - name: Setup macOS
        if: runner.os == 'macOS'
        run: |
          echo "Building CPU-only version for macOS"

      # Build wheel using uv (Linux/Windows use CUDA, macOS CPU-only)
      - name: Build wheel (Linux)
        if: runner.os == 'Linux'
        env:
          CUDACXX: /usr/local/cuda-12.4/bin/nvcc
          CUDAToolkit_ROOT: /usr/local/cuda-12.4
          CMAKE_CUDA_COMPILER: /usr/local/cuda-12.4/bin/nvcc
        run: |
          uv build --wheel
        shell: bash
      - name: Build wheel (Windows)
        if: runner.os == 'Windows'
        env:
          CUDACXX: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4\bin\nvcc.exe
          CUDAToolkit_ROOT: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4
          CMAKE_CUDA_COMPILER: C:\Program Files\NVIDIA GPU Computing Toolkit\CUDA\v12.4\bin\nvcc.exe
        run: |
          uv build --wheel
        shell: bash
      - name: Build wheel (macOS CPU-only)
        if: runner.os == 'macOS'
        env:
          CMAKE_ARGS: -DTIDE_ENABLE_CUDA=OFF
        run: |
          uv build --wheel
        shell: bash

      # Upload wheels
      - uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-py${{ matrix.python-version }}
          path: dist/*.whl

  build_sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Build sdist
        run: uv build --sdist

      - uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
